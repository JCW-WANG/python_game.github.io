<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Road Rage & Skill Evaluation Simulator</title>
    <style>
        /* --- 全局 UI 設定 --- */
        :root {
            --primary-color: #00ff88;
            --danger-color: #ff3333;
            --hud-bg: rgba(16, 20, 24, 0.85);
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
        }

        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #1a1a1a;
            color: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- 遊戲視窗 (Canvas) --- */
        #game-container {
            position: relative;
            flex: 1;
            background-color: #333;
            background-size: cover;
            background-position: center;
            transition: background-image 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* 這裡可以替換成您的 Canva 桌布連結 */
        .scenario-city { background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('https://images.unsplash.com/photo-1477959858617-67f85cf4f1df?auto=format&fit=crop&w=1600'); }
        .scenario-mountain { background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('https://images.unsplash.com/photo-1465447142348-e9952c393450?auto=format&fit=crop&w=1600'); }
        .scenario-highway { background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)), url('https://images.unsplash.com/photo-1596522354384-372977800067?auto=format&fit=crop&w=1600'); }

        /* --- HUD 儀表板 --- */
        #dashboard {
            height: 250px;
            background: var(--hud-bg);
            backdrop-filter: blur(10px);
            border-top: var(--glass-border);
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            padding: 20px;
            gap: 20px;
        }

        .cluster {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border: var(--glass-border);
            border-radius: 15px;
            background: rgba(255,255,255,0.05);
            padding: 15px;
        }

        /* 速度表 */
        .speedometer {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: 4px solid #444;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        .speed-value { font-size: 3em; font-weight: bold; color: var(--primary-color); }
        .speed-unit { font-size: 0.8em; color: #888; }

        /* 狀態燈號 */
        .indicators { display: flex; gap: 10px; margin-top: 10px; }
        .indicator { 
            width: 30px; height: 30px; border-radius: 50%; background: #333; 
            display: flex; align-items: center; justify-content: center; font-size: 12px;
            transition: all 0.2s;
        }
        .indicator.active { box-shadow: 0 0 10px currentColor; }
        .ind-left.active, .ind-right.active { background: #ffaa00; color: black; }
        .ind-sport.active { background: #ff0000; color: white; }

        /* 評分顯示 */
        .score-bar { width: 100%; height: 10px; background: #333; border-radius: 5px; margin-top: 5px; overflow: hidden; }
        .bar-fill { height: 100%; transition: width 0.3s; }
        .skill-fill { background: var(--primary-color); width: 50%; }
        .rage-fill { background: var(--danger-color); width: 0%; }

        /* 中間視野與事件提示 */
        #event-display {
            position: absolute;
            top: 20%;
            width: 100%;
            text-align: center;
            font-size: 2em;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        /* 開始選單 */
        #menu-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .menu-btn {
            padding: 15px 40px;
            margin: 10px;
            font-size: 1.2em;
            background: transparent;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            cursor: pointer;
            transition: 0.3s;
        }
        .menu-btn:hover { background: var(--primary-color); color: black; }

        /* 控制說明 */
        .controls-hint {
            position: absolute;
            bottom: 260px;
            right: 20px;
            background: rgba(0,0,0,0.5);
            padding: 10px;
            border-radius: 8px;
            font-size: 0.8em;
            color: #aaa;
        }
    </style>
</head>
<body>

    <div id="menu-overlay">
        <h1>駕駛行為評估模擬器</h1>
        <p>請選擇您的情境</p>
        <button class="menu-btn" onclick="game.startScenario('city')">情境一：繁忙市區 [cite: 6]</button>
        <button class="menu-btn" onclick="game.startScenario('mountain')">情境二：山區道路 [cite: 22]</button>
        <button class="menu-btn" onclick="game.startScenario('highway')">情境三：高速公路 [cite: 37]</button>
        <br>
        <div style="color: #666; font-size: 0.9em;">
            車輛預設: 家庭轎車 (1800cc) [cite: 2]<br>
            按鍵: ↑加速 ↓煞車 ←→轉向 Space:手煞車 S:運動模式 Q/E:方向燈
        </div>
    </div>

    <div id="game-container" class="scenario-city">
        <div id="event-display">前方出現障礙物！</div>
        <div class="controls-hint">
            W/↑: 加速 | S/↓: 煞車<br>
            A/D: 轉向 | Shift: 運動模式<br>
            Q/E: 方向燈
        </div>
    </div>

    <div id="dashboard">
        <div class="cluster">
            <h3>車輛狀態</h3>
            <div style="width: 100%; text-align: left;">
                <p>檔位: <span id="gear-display" style="font-size: 1.5em; font-weight: bold;">D</span></p>
                <div class="indicators">
                    <div id="ind-left" class="indicator ind-left">◀</div>
                    <div id="ind-sport" class="indicator ind-sport">S</div>
                    <div id="ind-right" class="indicator ind-right">▶</div>
                </div>
            </div>
        </div>

        <div class="cluster">
            <div class="speedometer">
                <span class="speed-value" id="speed-val">0</span>
                <span class="speed-unit">KM/H</span>
            </div>
        </div>

        <div class="cluster">
            <h3>即時評估 [cite: 4]</h3>
            <div style="width: 100%">
                <div style="display:flex; justify-content:space-between;">
                    <span>駕駛技術</span>
                    <span id="skill-val">50</span>
                </div>
                <div class="score-bar"><div id="skill-bar" class="bar-fill skill-fill"></div></div>
                
                <div style="display:flex; justify-content:space-between; margin-top: 10px;">
                    <span>路怒指數</span>
                    <span id="rage-val">0</span>
                </div>
                <div class="score-bar"><div id="rage-bar" class="bar-fill rage-fill"></div></div>
            </div>
        </div>
    </div>

    <script>
        // --- 遊戲邏輯核心 ---
        
        class DrivingGame {
            constructor() {
                // 基礎物理參數
                this.speed = 0;
                this.maxSpeed = 180;
                this.acceleration = 0.5;
                this.braking = 1.2;
                this.friction = 0.1;
                this.steering = 0;
                
                // 車輛狀態
                this.gear = "D";
                this.sportMode = false; // [cite: 3]
                this.turnSignal = "none"; // [cite: 3]
                this.vehicleType = "sedan"; // [cite: 2]

                // 評分變數
                this.roadRageScore = 0; // [cite: 53]
                this.drivingSkillScore = 50; // [cite: 58]
                
                // 輸入狀態
                this.keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false, w: false, s: false, a: false, d: false };
                
                // 遊戲循環
                this.isRunning = false;
                this.scenario = null;
                
                this.initListeners();
            }

            initListeners() {
                window.addEventListener('keydown', (e) => this.handleInput(e, true));
                window.addEventListener('keyup', (e) => this.handleInput(e, false));
            }

            handleInput(e, isDown) {
                // 方向鍵與 WASD
                if (Object.keys(this.keys).includes(e.key)) {
                    this.keys[e.key] = isDown;
                }
                
                // 功能鍵 (只在按下去時觸發一次)
                if (isDown) {
                    switch(e.key.toLowerCase()) {
                        case 's': // Sport Mode 切換 (若不是按住煞車的s)
                            if (e.key === 'S') this.toggleSportMode(); // Shift+s to ensure distinguish from brake if using wasd
                            break;
                        case 'shift': this.toggleSportMode(); break;
                        case 'q': this.toggleSignal('left'); break;
                        case 'e': this.toggleSignal('right'); break;
                    }
                }
            }

            toggleSportMode() {
                this.sportMode = !this.sportMode;
                document.getElementById('ind-sport').classList.toggle('active');
                // Sport 模式下加速提升 
                this.acceleration = this.sportMode ? 0.8 : 0.5; 
                this.updateUI();
            }

            toggleSignal(side) {
                if (this.turnSignal === side) this.turnSignal = 'none';
                else this.turnSignal = side;
                
                document.getElementById('ind-left').classList.toggle('active', this.turnSignal === 'left');
                document.getElementById('ind-right').classList.toggle('active', this.turnSignal === 'right');
            }

            startScenario(type) {
                this.scenario = type;
                this.isRunning = true;
                
                // 更新背景
                const bg = document.getElementById('game-container');
                bg.className = '';
                bg.classList.add(`scenario-${type}`);
                
                // 隱藏選單
                document.getElementById('menu-overlay').style.display = 'none';
                
                // 開始隨機事件循環
                this.startEventLoop();
                
                // 開始物理循環
                requestAnimationFrame(() => this.gameLoop());
            }

            gameLoop() {
                if (!this.isRunning) return;

                this.updatePhysics();
                this.checkRules();
                this.updateUI();
                
                requestAnimationFrame(() => this.gameLoop());
            }

            updatePhysics() {
                // 加速邏輯
                const isGas = this.keys.ArrowUp || this.keys.w;
                const isBrake = this.keys.ArrowDown || this.keys.s;

                if (isGas) {
                    this.speed += this.acceleration;
                    // 檢查急加速 [cite: 31]
                    if (this.sportMode && Math.random() > 0.95) this.triggerFeedback("激烈加速!", "rage");
                } else {
                    this.speed -= this.friction; // 自然阻力
                }

                if (isBrake) {
                    // 檢查急煞 [cite: 13]
                    if (this.speed > 60) {
                        this.roadRageScore += 0.05;
                        this.triggerFeedback("急煞警告!", "danger");
                    }
                    this.speed -= this.braking;
                }

                // 限制速度
                this.speed = Math.max(0, Math.min(this.speed, this.maxSpeed));
            }

            checkRules() {
                // 根據情境的規則檢查 [cite: 6, 22, 37]
                
                // 1. 方向燈檢查 
                const isTurning = this.keys.ArrowLeft || this.keys.ArrowRight || this.keys.a || this.keys.d;
                if (isTurning && this.speed > 20 && this.turnSignal === 'none') {
                    this.drivingSkillScore -= 0.05; // 轉彎沒打燈扣分
                }

                // 2. 超速檢查
                let limit = 0;
                if (this.scenario === 'city') limit = 60;
                if (this.scenario === 'mountain') limit = 80;
                if (this.scenario === 'highway') limit = 110;

                if (this.speed > limit) {
                    this.roadRageScore += 0.02;
                    this.drivingSkillScore -= 0.02;
                }

                // 分數邊界
                this.drivingSkillScore = Math.max(0, Math.min(100, this.drivingSkillScore));
                this.roadRageScore = Math.max(0, Math.min(100, this.roadRageScore));
            }

            startEventLoop() {
                // 模擬隨機路況事件 [cite: 10, 26, 40]
                setInterval(() => {
                    if (this.speed > 0) {
                        const events = [
                            { text: "行人突然闖紅燈！", type: "brake" },
                            { text: "前方車輛急停！", type: "brake" },
                            { text: "路面濕滑 (山區)", type: "slow" }
                        ];
                        const evt = events[Math.floor(Math.random() * events.length)];
                        
                        // 只在特定情境觸發特定事件
                        if (this.scenario === 'mountain' && evt.type === 'slow') {
                           this.showEvent(evt.text);
                        } else if (Math.random() > 0.7) {
                           this.showEvent(evt.text);
                        }
                    }
                }, 8000);
            }

            showEvent(text) {
                const el = document.getElementById('event-display');
                el.innerText = text;
                el.style.opacity = 1;
                el.style.color = '#ff3333';
                
                setTimeout(() => {
                    el.style.opacity = 0;
                }, 2000);
            }

            triggerFeedback(msg, type) {
                // 用於顯示即時反饋的小文字，此處簡化處理
                if (Math.random() > 0.8) console.log(msg); 
            }

            updateUI() {
                // 更新速度表
                document.getElementById('speed-val').innerText = Math.floor(this.speed);
                
                // 更新分數條
                document.getElementById('skill-val').innerText = Math.floor(this.drivingSkillScore);
                document.getElementById('skill-bar').style.width = `${this.drivingSkillScore}%`;
                
                document.getElementById('rage-val').innerText = Math.floor(this.roadRageScore);
                document.getElementById('rage-bar').style.width = `${this.roadRageScore}%`;
                
                // 根據分數變色
                const rageBar = document.getElementById('rage-bar');
                if (this.roadRageScore > 60) rageBar.style.backgroundColor = '#ff0000'; // High Rage
                else rageBar.style.backgroundColor = '#ffaa00';
            }
        }

        // 初始化遊戲
        const game = new DrivingGame();

    </script>
</body>
</html>
