<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç¶“å…¸é›»å½±è½éŸ³è¾¨ä½ | OST Quiz Master</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;900&family=Noto+Sans+TC:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-gradient: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            --card-bg: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.15);
            --primary: #00d2ff; 
            --accent: #3a7bd5;  
            --gold: #f8c93e;
            --text-main: #ffffff;
            --text-sub: #b2bec3;
            --success: #00ff88;
            --error: #ff4b4b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Montserrat', 'Noto Sans TC', sans-serif;
            background: var(--bg-gradient);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            padding: 15px;
        }

        /* å‹•æ…‹èƒŒæ™¯ç²’å­ */
        body::before {
            content: '';
            position: absolute;
            width: 200vw;
            height: 200vh;
            background: radial-gradient(circle, rgba(58, 123, 213, 0.1) 0%, rgba(0,0,0,0) 50%);
            animation: rotateBg 20s linear infinite;
            z-index: -1;
        }
        @keyframes rotateBg { 100% { transform: rotate(360deg); } }

        .app-container {
            width: 100%;
            max-width: 600px;
            position: relative;
            z-index: 10;
        }

        /* ç»ç’ƒæ“¬æ…‹å¡ç‰‡ */
        .glass-panel {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.4);
            text-align: center;
            transition: opacity 0.4s ease, transform 0.4s ease;
            position: relative;
            overflow: hidden;
        }

        .hidden { display: none !important; opacity: 0; pointer-events: none; }

        /* æŒ‰éˆ•æ¨£å¼ */
        .btn {
            background: linear-gradient(90deg, var(--accent), #24243e);
            color: white;
            border: 1px solid rgba(255,255,255,0.2);
            padding: 15px 30px;
            font-size: 1.1rem;
            font-weight: 700;
            border-radius: 50px;
            cursor: pointer;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
            letter-spacing: 1px;
            margin-top: 20px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 8px 25px rgba(58, 123, 213, 0.5); border-color: var(--primary); }
        .btn:active { transform: scale(0.98); }

        /* Start Screen */
        .logo { font-size: 4.5rem; margin-bottom: 10px; animation: float 3s ease-in-out infinite; filter: drop-shadow(0 0 15px rgba(255,255,255,0.3)); }
        h1 { font-size: 2rem; margin-bottom: 5px; color: var(--text-main); font-weight: 900; letter-spacing: 1px; }
        .subtitle { color: var(--primary); font-size: 0.9rem; margin-bottom: 25px; letter-spacing: 2px; text-transform: uppercase; }
        .instruction { font-size: 0.9rem; color: var(--text-sub); margin: 20px 0; line-height: 1.8; text-align: left; background: rgba(0,0,0,0.3); padding: 20px; border-radius: 15px; border-left: 4px solid var(--primary); }
        
        /* Game Screen */
        .hud-bar { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; font-size: 1rem; color: var(--primary); align-items: center; }
        
        .visualizer-wrapper {
            position: relative; width: 100%; height: 100px;
            background: rgba(0,0,0,0.3); border-radius: 15px;
            margin-bottom: 20px; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        canvas { width: 100%; height: 100%; }
        .loading-text { position: absolute; color: var(--text-sub); font-size: 0.8rem; letter-spacing: 2px; animation: pulse 1.5s infinite; }

        .timer-bar-container { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin: 15px 0 25px 0; overflow: hidden; }
        .timer-fill { height: 100%; background: var(--gold); width: 100%; transition: width 1s linear; box-shadow: 0 0 10px var(--gold); }

        .options-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        .option-btn {
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            color: white;
            padding: 18px 15px;
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
            position: relative;
            overflow: hidden;
            display: flex; align-items: center; justify-content: space-between;
        }
        .option-btn:hover:not(:disabled) { background: rgba(255,255,255,0.15); border-color: var(--primary); transform: translateX(5px); }
        .option-btn.correct { background: rgba(0, 255, 136, 0.25); border-color: var(--success); color: var(--success); font-weight: bold; }
        .option-btn.wrong { background: rgba(255, 51, 51, 0.25); border-color: var(--error); color: var(--error); opacity: 0.6; }

        /* Score Floating Animation */
        .score-float {
            position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
            font-weight: bold; font-size: 1.2rem; animation: floatUp 0.8s ease-out forwards;
        }
        .score-float.plus { color: var(--success); }
        .score-float.minus { color: var(--error); }

        /* Result Overlay */
        .result-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(15, 20, 28, 0.98); backdrop-filter: blur(15px);
            z-index: 20; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            border-radius: 24px;
            animation: fadeIn 0.4s ease;
            padding: 25px;
        }
        .res-status { font-size: 1.8rem; margin-bottom: 10px; font-weight: 900; }
        .res-title { font-size: 1.5rem; color: var(--gold); margin-bottom: 5px; font-weight: bold; }
        .res-song { font-size: 1rem; color: var(--primary); margin-bottom: 15px; font-style: italic; background: rgba(255,255,255,0.1); padding: 5px 15px; border-radius: 15px;}
        .res-desc { 
            font-size: 0.9rem; color: #ddd; line-height: 1.6; margin-bottom: 25px; 
            text-align: justify; max-height: 150px; overflow-y: auto;
            border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px;
        }

        /* End Screen */
        .score-display { font-size: 4.5rem; font-weight: 900; color: var(--gold); text-shadow: 0 0 30px rgba(248, 201, 62, 0.4); margin: 20px 0; }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(-50%); } 100% { opacity: 0; transform: translateY(-150%); } }

        @media (min-width: 600px) {
            .options-grid { grid-template-columns: 1fr 1fr; }
            h1 { font-size: 2.5rem; }
            .logo { font-size: 5rem; }
        }
    </style>
</head>
<body>

<div class="app-container">

    <div id="start-screen" class="glass-panel">
        <div class="logo">ğŸ§</div>
        <h1>é›»å½±çŒœè¬å¤§å¸«</h1>
        <p class="subtitle">OST è½éŸ³è¾¨ä½æŒ‘æˆ°</p>
        
        <div class="instruction">
            <p>ğŸµ <b>ç¶“å…¸é‡ç¾</b>ï¼šè†è½é…æ¨‚ï¼Œé¸å‡ºæ­£ç¢ºé›»å½±ã€‚</p>
            <p>ğŸ² <b>éš¨æ©Ÿé¡Œåº«</b>ï¼šæ¯æ¬¡éŠç©éš¨æ©ŸæŠ½é¸ 10 é¡Œã€‚</p>
            <p>â±ï¸ <b>é™æ™‚æŒ‘æˆ°</b>ï¼šæ¯é¡Œ 30 ç§’ï¼Œè¶Šå¿«å¾—åˆ†è¶Šé«˜ã€‚</p>
            <p>ğŸ“– <b>æ·±åº¦è§£æ</b>ï¼šç­”é¡Œå¾Œé™„å¸¶è©³ç´°åŠ‡æƒ…èˆ‡å½©è›‹ã€‚</p>
        </div>

        <button class="btn" id="start-btn">é–‹å§‹éŠæˆ²</button>
    </div>

    <div id="game-screen" class="glass-panel hidden">
        <div class="hud-bar">
            <span>ç¬¬ <span id="current-q">1</span>/10 é¡Œ</span>
            <span>å¾—åˆ†: <span id="score">0</span></span>
        </div>

        <div class="visualizer-wrapper">
            <canvas id="audio-visualizer"></canvas>
            <div id="loading-msg" class="loading-text">BUFFERING...</div>
        </div>

        <div class="timer-bar-container">
            <div class="timer-fill" id="timer-fill"></div>
        </div>

        <div id="status-text" style="height: 20px; margin-bottom: 15px; font-weight: bold; color: var(--text-sub); font-size: 0.9rem;">æº–å‚™æ’­æ”¾...</div>

        <div class="options-grid" id="options-container">
            </div>

        <div id="result-overlay" class="result-overlay hidden">
            <h2 id="res-status" class="res-status">Correct!</h2>
            <h3 id="res-title" class="res-title">é›»å½±æ¨™é¡Œ</h3>
            <div id="res-song" class="res-song">ğŸµ Song Name</div>
            <p id="res-desc" class="res-desc">åŠ‡æƒ…æè¿°...</p>
            <button class="btn" id="next-btn" style="width: auto; padding: 12px 40px;">ä¸‹ä¸€é¡Œ</button>
        </div>
    </div>

    <div id="end-screen" class="glass-panel hidden">
        <div class="logo">ğŸ†</div>
        <h1>éŠæˆ²çµæŸ</h1>
        <p style="color: var(--text-sub)">ä½ çš„æœ€çµ‚å¾—åˆ†</p>
        <div class="score-display" id="final-score">0</div>
        <p id="feedback-msg" style="color: var(--text-main); margin-bottom: 30px; font-size: 1.1rem; line-height: 1.6;">...</p>
        <button class="btn" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
    </div>

</div>

<audio id="bgm-player" crossOrigin="anonymous" preload="auto"></audio>

<script>

/**
 * âš ï¸ [é‡è¦] è«‹å°‡æ­¤è™•çš„ DEFAULT_AUDIO æ›¿æ›ç‚ºæ‚¨çš„ MP3 æª”æ¡ˆé€£çµ
 * ç‚ºäº†æ¼”ç¤ºæ•ˆæœï¼Œé€™è£¡ä½¿ç”¨äº†ä¸€å€‹é€šç”¨çš„æ¸¬è©¦é€£çµã€‚
 * æ‚¨å¿…é ˆæ‰‹å‹•æ›´æ–° ALL_MOVIES é™£åˆ—ä¸­çš„ audioUrlã€‚
 */
const DEFAULT_AUDIO = "https://cdn.pixabay.com/download/audio/2022/03/24/audio_349692d77d.mp3"; 

const ALL_MOVIES = [
    { title: "éµé”å°¼è™Ÿ (Titanic)", song: "My Heart Will Go On", year: "1997", desc: "å½±å²æ„›æƒ…ç¶“å…¸ã€‚çª®ç•«å®¶å‚‘å…‹èˆ‡è²´æ—å°‘å¥³è˜¿çµ²åœ¨è±ªè¯éƒµè¼ªä¸Šç›¸æˆ€ï¼Œå»é­é‡ä¸–ç´€èˆ¹é›£ï¼Œè­œå‡ºä¸€æ®µæ°¸æ†çš„æ‚²åŠ‡æˆ€æ›²ã€‚", audioUrl: },
    { title: "æœˆè€ (Till We Meet Again)", song: "å¦‚æœå¯ä»¥", year: "2021", desc: "ä¹æŠŠåˆ€åŸ·å°ã€‚æ…˜é­é›·æ“Šè€Œæ­»çš„é˜¿ç¶¸ä¾†åˆ°é™°é–“ï¼Œç‚ºäº†ç©é™°å¾·è½‰ä¸–ï¼Œèˆ‡å€‹æ€§ç«çˆ†çš„Pinkyæ­æª”æˆç‚ºæœˆè€ï¼Œç‰½èµ·ç´…ç·šçš„æ•…äº‹ã€‚", audioUrl:  },
    { title: "ç•¶ç”·äººæˆ€æ„›æ™‚", song: "æ„›æƒ…ä½ æ¯”æˆ‘æƒ³çš„é–£è¼ƒå‰å¤§", year: "2021", desc: "æ”¹ç·¨è‡ªéŸ“åœ‹é›»å½±ã€‚è¨å‚µæµæ°“é˜¿æˆæ„›ä¸Šæ›¿çˆ¶è¦ªèƒŒå‚µçš„æµ©å©·ï¼Œå±•é–‹ä¸€æ®µå°å‘³åè¶³ã€ç¬‘ä¸­å¸¶æ·šçš„è™å¿ƒæˆ€æƒ…ã€‚", audioUrl: },
    { title: "åˆ»åœ¨ä½ å¿ƒåº•çš„åå­—", song: "åˆ»åœ¨æˆ‘å¿ƒåº•çš„åå­—", year: "2020", desc: "å‰›è§£åš´çš„å°ç£ï¼Œå…©ä½é«˜ä¸­ç”·å­©é˜¿æ¼¢èˆ‡Birdyåœ¨å£“æŠ‘çš„ç¤¾æœƒæ°›åœä¸‹ï¼Œæ¢ç´¢å½¼æ­¤é–“æ¨¡ç³Šæ›–æ˜§ã€åˆ»éª¨éŠ˜å¿ƒçš„åˆæˆ€ã€‚", audioUrl: },
    { title: "ç©å‘½é—œé ­7 (Furious 7)", song: "See You Again", year: "2015", desc: "ç³»åˆ—ä½œæƒ…æ„Ÿæœ€æ¿ƒåšçš„ä¸€é›†ã€‚å”è€å¤§åœ˜éšŠé¢å°å¼·æ•µæˆ´å…‹è•­çš„å¾©ä»‡ï¼ŒåŒæ™‚é€™ä¹Ÿæ˜¯ä¿ç¾…Â·æ²ƒå…‹æœ€å¾Œçš„éŠ€å¹•å‘Šåˆ¥ä½œã€‚", audioUrl:  },
    { title: "å¹´å°‘æ—¥è¨˜", song: "é…æ¨‚ (å¹´å°‘æ—¥è¨˜)", year: "2023", desc: "é¦™æ¸¯åŠ‡æƒ…ç‰‡ã€‚ä¸€åä¸­å­¸è€å¸«ç™¼ç¾å­¸ç”Ÿçš„éºæ›¸ï¼Œé€²è€Œå›æ†¶èµ·è‡ªå·±ç«¥å¹´é­å—å®¶åº­æš´åŠ›èˆ‡åš´è‹›æ•™è‚²çš„å‰µå‚·ã€‚", audioUrl:  },
    { title: "å›å®´ (The Wedding Banquet)", song: "ç¶“å…¸é…æ¨‚", year: "1993", desc: "æå®‰ã€Œçˆ¶è¦ªä¸‰éƒ¨æ›²ã€ä¹‹ä¸€ã€‚ç‚ºäº†æ‡‰ä»˜çˆ¶æ¯é€¼å©šï¼Œæ—…ç¾åŒå¿—å‰åŒæ±ºå®šèˆ‡ä¸­åœ‹å¥³ç•«å®¶å‡çµå©šï¼Œå¼•ç™¼ä¸€é€£ä¸²æ–‡åŒ–èˆ‡å®¶åº­è¡çªã€‚", audioUrl: },
    { title: "æ€ªç‰© (Monster)", song: "å‚æœ¬é¾ä¸€ é…æ¨‚", year: "2023", desc: "æ˜¯æè£•å’ŒåŸ·å°ï¼Œå‚æœ¬é¾ä¸€éºä½œé…æ¨‚ã€‚é€éæ¯è¦ªã€è€å¸«ã€å­©å­ä¸‰ç¨®è¦–è§’ï¼Œé€æ­¥æ­é–‹æ ¡åœ’éœ¸å‡Œç–‘é›²èƒŒå¾Œçš„æ®˜é…·çœŸç›¸ã€‚", audioUrl:  },
    { title: "å·´é»å¾·å· (Paris, Texas)", song: "Paris, Texas (Guitar)", year: "1984", desc: "æº«å¾·æ–¯ç¶“å…¸å…¬è·¯é›»å½±ã€‚å¤±æ†¶ç”·å­åœ¨å¾·å·è’æ¼ ä¸­æ¼«éŠï¼Œè©¦åœ–å°‹æ‰¾å¤±æ•£çš„å¦»å…’èˆ‡è‡ªæˆ‘ï¼ŒRy Cooderçš„å‰ä»–é…æ¨‚è’¼æ¶¼å‹•äººã€‚", audioUrl:  },
    { title: "å–®èº«å‹•ç‰©åœ’ (The Lobster)", song: "String Quartet in F Major", year: "2015", desc: "åçƒæ‰˜é‚¦é»‘è‰²å–œåŠ‡ã€‚åœ¨æœªä¾†ç¤¾æœƒï¼Œå–®èº«æ˜¯æœ‰ç½ªçš„ï¼Œå¦‚æœåœ¨45å¤©å…§æ‰¾ä¸åˆ°ä¼´ä¾¶ï¼Œå°±æœƒè¢«è®Šæˆä¸€ç¨®å‹•ç‰©æµæ”¾ã€‚", audioUrl:  },
    { title: "æ˜å¤©ï¼Œæˆ‘è¦å’Œæ˜¨å¤©çš„ä½ ç´„æœƒ", song: "Happy End", year: "2016", desc: "äº¬éƒ½èƒŒæ™¯çš„å¥‡å¹»æ„›æƒ…ã€‚ç”·å¥³ä¸»è§’èº«è™•ç›¸åçš„æ™‚é–“è»¸ï¼Œæ¯äº”å¹´ç›¸é‡ä¸€æ¬¡ï¼Œä»–çš„ç¬¬ä¸€æ¬¡ç›¸é‡å»æ˜¯å¥¹çš„æœ€å¾Œä¸€æ¬¡ã€‚", audioUrl:  },
    { title: "ä»¥ä½ çš„åå­—å‘¼å–šæˆ‘", song: "Mystery of Love", year: "2017", desc: "ç¾©å¤§åˆ©å¤æ—¥ã€‚17æ­²å°‘å¹´åŸƒåˆ©å¥§èˆ‡çˆ¶è¦ªçš„ç ”ç©¶ç”ŸåŠ©ç†å¥§åˆ©ä½›ï¼Œå±•é–‹ä¸€æ®µçŸ­æš«ã€ç†¾ç†±ä¸”æ”¹è®Šå½¼æ­¤ä¸€ç”Ÿçš„æ„›æˆ€ã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "æ¿æ°´æ¼‚æµ", song: "æ¿æ°´æ¼‚æµ (é…æ¨‚)", year: "2021", desc: "æ”¹ç·¨è‡ªçœŸå¯¦äº‹ä»¶ã€‚æè¿°ä¸€ç¾¤åœ¨æ·±æ°´åŸ—å¤©æ©‹åº•ä¸‹çš„éœ²å®¿è€…ï¼Œå…¶å®¶ç•¶è¢«æ”¿åºœå¼·è¡Œæ¸…æƒå¾Œï¼Œå …æŒæå‘Šçˆ­å–å°Šåš´çš„æ•…äº‹ã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "æœ‰ç—…æ‰æœƒå–œæ­¡ä½  (Sick of Myself)", song: "é…æ¨‚", year: "2022", desc: "è«·åˆºé»‘è‰²å–œåŠ‡ã€‚å¥³ä¸»è§’ç‚ºäº†åšå–ç”·å‹èˆ‡å¤§çœ¾çš„é—œæ³¨ï¼Œä¸æƒœæœç”¨ç¦è—¥è®“è‡ªå·±çš®è†šæ½°çˆ›ï¼Œé™·å…¥è‡ªæ¯€çš„æ·±æ·µã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "éˆé­‚æ€¥è½‰å½ (Soul)", song: "It's All Right", year: "2020", desc: "çš®å…‹æ–¯å‚‘ä½œã€‚ä¸€ä½ä¸å¾—å¿—çš„çˆµå£«é‹¼ç´å®¶æ„å¤–èº«äº¡ï¼Œåœ¨ã€ŒæŠ•èƒå…ˆä¿®ç­ã€è©¦åœ–å°‹æ‰¾ç”Ÿå‘½çš„ç«èŠ±èˆ‡æ´»è‘—çš„æ„ç¾©ã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "æˆ€å¤500æ—¥ (500 Days of Summer)", song: "There Is A Light...", year: "2009", desc: "éå…¸å‹çš„æ„›æƒ…é›»å½±ã€‚è¬›è¿°ç›¸ä¿¡çœŸæ„›çš„æ¹¯å§†é‡è¦‹ä¸ç›¸ä¿¡æ„›æƒ…çš„å¤å¤©ï¼Œå…©äººåœ¨500å¤©å…§å¾ç†±æˆ€åˆ°åˆ†æ‰‹çš„é…¸ç”œè‹¦è¾£ã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "ä¸€å€‹å·¨æ˜Ÿçš„èª•ç”Ÿ (A Star Is Born)", song: "Shallow", year: "2018", desc: "å¸ƒèŠå¾·åˆ©åº«æŸèˆ‡å¥³ç¥å¡å¡ä¸»æ¼”ã€‚é…—é…’çš„éæ°£é„‰æ‘æ­Œæ‰‹ç™¼æ˜äº†æ“æœ‰å¤©ç±Ÿæ­Œå–‰çš„ç´ äººï¼Œå…©äººåœ¨æ„›èˆ‡ååˆ©ä¸­æ™æ‰ã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "æè¡›æˆ°å£«ï¼šç¨è¡Œä¿ ", song: "Hold My Hand", year: "2022", desc: "æ™‚éš”36å¹´çš„çºŒé›†ã€‚é ‚å°–é£›å®˜ã€Œç¨è¡Œä¿ ã€é‡å›æµ·è»è¨“ç·´å­¸æ ¡æ•™å°æ–°ä¸€ä»£é£›è¡Œå“¡ï¼Œé¢å°éå»çš„éºæ†¾ä¸¦åŸ·è¡Œä¸å¯èƒ½çš„ä»»å‹™ã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "é ­æ–‡å­—D (Initial D)", song: "ä¸€è·¯å‘åŒ— / Drifting", year: "2005", desc: "å‘¨æ°å€«ä¸»æ¼”ã€‚è¬›è¿°è±†è…åº—å…’å­è—¤åŸæ‹“æµ·é§•é§›AE86ï¼Œåœ¨ç§‹åå±±å±•ç¾é©šäººç”©å°¾æŠ€è¡“ï¼Œæ“Šæ•—å„è·¯è³½è»Šå¥½æ‰‹çš„æ•…äº‹ã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "Kæ­Œæƒ…äºº (Music and Lyrics)", song: "Way Back Into Love", year: "2007", desc: "éæ°£çš„80å¹´ä»£æµè¡Œå¶åƒèˆ‡ä¸€ä½æœ‰æ–‡é‡‡çš„æ¤ç‰©ç…§é¡§å“¡ï¼Œå…©äººè¢«è¿«åˆä½œå¯«æ­Œï¼Œåœ¨éŸ³ç¬¦ä¸­è­œå‡ºæµªæ¼«æˆ€æ›²ã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "çœŸæ„›æ¯ä¸€å¤© (About Time)", song: "How Long Will I Love You", year: "2013", desc: "æº«æš–ç™‚ç™’ç³»é›»å½±ã€‚ç”·ä¸»è§’æ“æœ‰ç©¿è¶Šæ™‚ç©ºå›åˆ°éå»çš„èƒ½åŠ›ï¼Œä»–è©¦åœ–ç”¨é€™ä»½èƒ½åŠ›è®“æ¯ä¸€å¤©éå¾—å®Œç¾ï¼Œä¸¦è´å¾—æ„›æƒ…ã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "è½è¦‹ä¸‹é›¨çš„è²éŸ³", song: "è½è¦‹ä¸‹é›¨çš„è²éŸ³", year: "2013", desc: "æ–¹æ–‡å±±åŸ·å°ã€‚ä»¥æ¼¢æœæ–‡åŒ–èˆ‡é›¨å¤©ç‚ºèƒŒæ™¯ï¼Œè¬›è¿°è½éšœå¥³ä¸»è§’èˆ‡æ¨‚åœ˜ä¸»å”±ä¹‹é–“å”¯ç¾è€Œè©©æ„çš„æ„›æƒ…æ•…äº‹ã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "æ ¼é›·çš„äº”åé“é™°å½±", song: "Love Me Like You Do", year: "2015", desc: "æ”¹ç·¨è‡ªæš¢éŠ·å°èªªã€‚ç´”çœŸå¥³å¤§å­¸ç”Ÿæ¡è¨ªå¹´è¼•å„„è¬å¯Œè±ªï¼Œå»ä¸€æ­¥æ­¥é™·å…¥ä»–ç‰¹æ®Šçš„æ€§æ„›ç™–å¥½èˆ‡æ§åˆ¶æ…¾çš„é—œä¿‚ä¸­ã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "æ¨‚ä¾†æ¨‚æ„›ä½  (La La Land)", song: "City of Stars", year: "2016", desc: "ç»çµ¦è¿½å¤¢äººçš„æƒ…æ›¸ã€‚åœ¨æ´›æ‰ç£¯ï¼Œä¸€ä½è½é­„çˆµå£«é‹¼ç´å®¶èˆ‡æ‡·æ‰ä¸é‡çš„å¥³æ¼”å“¡ç›¸æ„›ï¼Œå»åœ¨å¤¢æƒ³èˆ‡ç¾å¯¦é–“é¢è‡¨æŠ‰æ“‡ã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "æš®å…‰ä¹‹åŸï¼šç ´æ›‰", song: "A Thousand Years", year: "2011", desc: "å¸è¡€é¬¼ç¾…æ›¼å²æœ€çµ‚ç« ã€‚è²æ‹‰èˆ‡æ„›å¾·è¯çµ‚æ–¼æ­¥å…¥ç¦®å ‚ï¼Œä½†æ–°ç”Ÿå‘½çš„èª•ç”Ÿå»å¼•ç™¼äº†ä½›æœé‡Œå®¶æ—çš„æ®ºæ©Ÿã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "å¯å¯å¤œç¸½æœƒ (Coco)", song: "Remember Me", year: "2017", desc: "å¢¨è¥¿å“¥äº¡éˆç¯€èƒŒæ™¯ã€‚ç†±æ„›éŸ³æ¨‚çš„å°ç”·å­©ç±³é«˜èª¤é—–é™°é™½ç•Œï¼Œåœ¨å°‹æ‰¾ç¥–å…ˆçš„éç¨‹ä¸­ï¼Œæ­é–‹å®¶æ—éš±è—å¤šå¹´çš„ç§˜å¯†ã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "æ­»ä¾2 (Deadpool 2)", song: "Ashes", year: "2018", desc: "å˜´ç ²è¶…ç´šè‹±é›„å›æ­¸ã€‚æ­»ä¾ç‚ºäº†ä¿è­·ä¸€åè®Šç¨®äººå°å­©ï¼Œçµ„æˆäº†ã€ŒXç‰¹æ”»éšŠã€ï¼Œå±•é–‹ä¸€å ´è¡€è…¥åˆçˆ†ç¬‘çš„æ•‘æ´è¡Œå‹•ã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "ç­‰ä¸€å€‹äººå’–å•¡", song: "ç¼ºå£", year: "2014", desc: "ä¹æŠŠåˆ€å°èªªæ”¹ç·¨ã€‚è¬›è¿°ã€Œç­‰ä¸€å€‹äººå’–å•¡ã€åº—è£¡ï¼Œå¤§å­¸æ–°é®®äººæ€è¢èˆ‡çœ‹ä¼¼è’èª•çš„é˜¿æ‹“ï¼Œä»¥åŠè€é—†å¨˜ä¹‹é–“ç­‰å¾…æ„›æƒ…çš„æ•…äº‹ã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "ç¾å¥³èˆ‡é‡ç¸", song: "Beauty and the Beast", year: "2017", desc: "è¿ªå£«å°¼ç¶“å…¸çœŸäººç‰ˆã€‚ç‚ºäº†æ•‘çˆ¶è¦ªï¼Œè²å…’è‡ªé¡˜ç•™åœ¨è¢«è©›å’’çš„åŸå ¡èˆ‡é‡ç¸å…±è™•ï¼Œæœ€çµ‚ç”¨çœŸæ„›æ‰“ç ´äº†é­”å’’ã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "å°æ™‚ä»£", song: "æ™‚é–“ç…®é›¨", year: "2013", desc: "è¬›è¿°å››ä½å¥³å¤§å­¸ç”Ÿåœ¨ç¹è¯çš„ä¸Šæµ·ï¼Œç¶“æ­·æ„›æƒ…ã€å‹æƒ…èˆ‡è·å ´çš„è€ƒé©—ï¼Œå±•ç¾å¥¢è¯ç”Ÿæ´»ä¸‹çš„é’æ˜¥è¿·æƒ˜ã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "æµ·æ´‹ä¹‹å¿ƒ (Moana)", song: "How Far I'll Go", year: "2016", desc: "ç»é‡Œå°¼è¥¿äºå³¶å¶¼çš„é…‹é•·å¥³å…’è«å¨œï¼Œç‚ºäº†æ‹¯æ•‘æ—äººï¼Œæšå¸†å‡ºæµ·å°‹æ‰¾åŠç¥äººæ¯›ä¼Šï¼Œæ­¸é‚„æµ·æ´‹ä¹‹å¿ƒçš„å†’éšªæ—…ç¨‹ã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "æ³¢å¸Œç±³äºç‹‚æƒ³æ›²", song: "Bohemian Rhapsody", year: "2018", desc: "çš‡ååˆå”±åœ˜å‚³è¨˜é›»å½±ã€‚ç´€éŒ„ä¸»å”±ä½›èŠè¿ªÂ·å¢¨è£˜ç‘å¾ç„¡åå°å’æˆç‚ºæ–æ»¾å‚³å¥‡çš„éç¨‹ï¼Œä»¥åŠéœ‡æ’¼ä¸–ç•Œçš„Live Aidæ¼”å‡ºã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "æ­ŒåŠ‡é­…å½±", song: "The Phantom of the Opera", year: "2004", desc: "ç™¾è€åŒ¯æœ€é•·å£½éŸ³æ¨‚åŠ‡æ”¹ç·¨ã€‚å·´é»æ­ŒåŠ‡é™¢åœ°ä¸‹èº²è—è‘—ä¸€ä½æ¯€å®¹çš„éŸ³æ¨‚å¤©æ‰ï¼Œä»–ç˜‹ç‹‚åœ°æ„›ä¸Šäº†å¹´è¼•å¥³é«˜éŸ³å…‹è‰çµ²æ±€ã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "å¤§å¨›æ¨‚å®¶", song: "This Is Me", year: "2017", desc: "å‚³å¥‡é¦¬æˆ²åœ˜å§‹ç¥–P.T.å·´ç´å§†çš„ç™¼è·¡æ•…äº‹ã€‚ä»–é›†çµäº†å„ç¨®å¥‡äººç•°å£«ï¼Œå°‡å‚™å—æ­§è¦–çš„æ€ªèƒè®Šæˆäº†èˆå°ä¸Šæœ€é–ƒè€€çš„æ˜æ˜Ÿã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "ç«ç®­äºº (Rocketman)", song: "Rocket Man", year: "2019", desc: "è‰¾çˆ¾é “Â·å¼·çš„éŸ³æ¨‚å‚³è¨˜ã€‚ä»¥å¥‡å¹»æ­Œèˆå½¢å¼ï¼Œå‘ˆç¾ä»–å¾å®³ç¾çš„é‹¼ç´ç¥ç«¥è®Šèº«ç‚ºå…¨çƒæµè¡Œå·¨æ˜Ÿçš„ç˜‹ç‹‚æ­²æœˆã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "ç¥åŠ›å¥³è¶…äºº", song: "Is She With You?", year: "2017", desc: "äºé¦¬éœå…¬ä¸»é»›å®‰å¨œæ•‘äº†ä¸€åé£›è¡Œå“¡ï¼Œå¾—çŸ¥å¤–é¢çš„ä¸–ç•Œæ­£ç¶“æ­·ç¬¬ä¸€æ¬¡ä¸–ç•Œå¤§æˆ°ï¼Œæ¯…ç„¶æ±ºç„¶é›¢é–‹å®¶é„‰æŠ•å…¥æˆ°å ´ã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "F1 (ä¸€ç´šæ–¹ç¨‹å¼)", song: "Formula 1 Theme", year: "2025", desc: "å¸ƒèŠå¾·Â·å½¼ç‰¹ä¸»æ¼”ã€‚è¬›è¿°ä¸€ä½é€€å½¹çš„ä¸€ç´šæ–¹ç¨‹å¼è³½è»Šæ‰‹é‡è¿”è³½é“ï¼ŒæŒ‡å°æ–°ç§€ä¸¦å†æ¬¡æŒ‘æˆ°æ¥µé€Ÿçš„æ•…äº‹ã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "çµ•åœ°æ•‘æ´ (The Martian)", song: "Starman", year: "2015", desc: "å¤ªç©ºäººé¦¬å…‹åœ¨ç«æ˜Ÿä»»å‹™ä¸­é­é‡é¢¨æš´è¢«èªå®šæ­»äº¡è€Œéºç•™ã€‚ä»–å¿…é ˆåœ¨è³‡æºåŒ±ä¹çš„ç«æ˜Ÿä¸Šé‹ç”¨ç§‘å­¸çŸ¥è­˜ç¨®é¦¬éˆ´è–¯æ±‚ç”Ÿã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "æœˆå…‰ç™½æ—¥å¤¢", song: "Moonage Daydream", year: "2022", desc: "å¤§è¡›Â·é®‘ä¼Šçš„å¯¦é©—æ€§ç´€éŒ„ç‰‡ã€‚é€éæœªå…¬é–‹çš„å½±åƒèˆ‡éŸ³æ¨‚ï¼Œæ¢ç´¢é€™ä½æ–æ»¾è®Šè‰²é¾çš„è—è¡“ç²¾ç¥èˆ‡å…§å¿ƒä¸–ç•Œã€‚", audioUrl: DEFAULT_AUDIO },
    { title: "å·´æ–¯å…‰å¹´", song: "Starman (Remix)", year: "2022", desc: "ç©å…·ç¸½å‹•å“¡å¤–å‚³ã€‚è¬›è¿°å•Ÿç™¼å·´æ–¯å…‰å¹´ç©å…·çš„é‚£ä½å‚³å¥‡å¤ªç©ºéŠä¿ ï¼Œåœ¨æ˜Ÿéš›é–“å°æŠ—æœ­å…‹å¤©ç‹çš„èµ·æºæ•…äº‹ã€‚", audioUrl: DEFAULT_AUDIO }
];

// ç‚ºé›»å½±åŠ ä¸Š ID
ALL_MOVIES.forEach((m, i) => m.id = i);

class GameEngine {
    constructor() {
        this.score = 0;
        this.qIndex = 0;
        this.questions = [];
        this.timer = null;
        this.maxTime = 30;
        this.timeLeft = 30;
        this.gameLength = 10;
        this.audioUnlocked = false;
        
        // Audio & Visualizer Context
        this.audioCtx = null;
        this.analyser = null;
        this.source = null;
        this.isAudioSetup = false;

        // DOM Elements
        this.els = {
            start: document.getElementById('start-screen'),
            game: document.getElementById('game-screen'),
            end: document.getElementById('end-screen'),
            audio: document.getElementById('bgm-player'),
            visualizer: document.getElementById('audio-visualizer'),
            loading: document.getElementById('loading-msg'),
            timerBar: document.getElementById('timer-fill'),
            options: document.getElementById('options-container'),
            overlay: document.getElementById('result-overlay'),
            status: document.getElementById('status-text'),
            score: document.getElementById('score'),
            qNum: document.getElementById('current-q'),
            resStatus: document.getElementById('res-status'),
            resTitle: document.getElementById('res-title'),
            resSong: document.getElementById('res-song'),
            resDesc: document.getElementById('res-desc')
        };

        // SFX Context
        this.sfxCtx = new (window.AudioContext || window.webkitAudioContext)();

        // Bindings
        document.getElementById('start-btn').addEventListener('click', () => this.initGame());
        document.getElementById('next-btn').addEventListener('click', () => this.nextQuestion());
        
        // Mobile Unlock Event
        this.unlockAudioEvent = this.unlockAudioEvent.bind(this);
        document.body.addEventListener('touchstart', this.unlockAudioEvent, { once: true });
        document.body.addEventListener('click', this.unlockAudioEvent, { once: true });
    }

    // iOS/Android Audio Unlocker (Integrated from old code logic)
    unlockAudioEvent() {
        if (this.audioUnlocked) return;
        
        // Resume Audio Contexts
        if (this.sfxCtx.state === 'suspended') this.sfxCtx.resume();
        
        // Play silent buffer to unlock media playback
        this.els.audio.play().then(() => {
            this.els.audio.pause();
            this.els.audio.currentTime = 0;
            this.audioUnlocked = true;
        }).catch(() => {});
    }

    playTone(type) {
        if (!this.sfxCtx) return;
        const osc = this.sfxCtx.createOscillator();
        const gain = this.sfxCtx.createGain();
        osc.connect(gain);
        gain.connect(this.sfxCtx.destination);

        if (type === 'correct') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(600, this.sfxCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1200, this.sfxCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, this.sfxCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, this.sfxCtx.currentTime + 0.3);
        } else {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, this.sfxCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(100, this.sfxCtx.currentTime + 0.3);
            gain.gain.setValueAtTime(0.1, this.sfxCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, this.sfxCtx.currentTime + 0.3);
        }
        osc.start();
        osc.stop(this.sfxCtx.currentTime + 0.3);
    }

    async initGame() {
        // Ensure Audio Context
        if (!this.audioCtx) {
            this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            this.setupVisualizer();
        }
        if (this.audioCtx.state === 'suspended') await this.audioCtx.resume();

        // Shuffle & Pick 10
        const shuffled = [...ALL_MOVIES].sort(() => Math.random() - 0.5);
        this.questions = shuffled.slice(0, this.gameLength);
        
        this.qIndex = 0;
        this.score = 0;
        this.els.score.innerText = 0;
        
        this.switchScreen('game');
        this.loadQuestion();
    }

    setupVisualizer() {
        if(this.isAudioSetup) return;
        try {
            this.analyser = this.audioCtx.createAnalyser();
            this.source = this.audioCtx.createMediaElementSource(this.els.audio);
            this.source.connect(this.analyser);
            this.analyser.connect(this.audioCtx.destination);
            this.analyser.fftSize = 256;
            this.isAudioSetup = true;
            this.drawVisualizer();
        } catch (e) { console.log("Visualizer fallback mode"); }
    }

    drawVisualizer() {
        const canvas = this.els.visualizer;
        const ctx = canvas.getContext('2d');
        const bufferLength = this.analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);

        const draw = () => {
            requestAnimationFrame(draw);
            this.analyser.getByteFrequencyData(dataArray);
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            const barWidth = (canvas.width / bufferLength) * 2.5;
            let x = 0;
            for(let i = 0; i < bufferLength; i++) {
                const barHeight = dataArray[i] / 255 * canvas.height;
                const hue = i * 2 + 180; // Cyan/Blue Theme
                ctx.fillStyle = `hsl(${hue}, 100%, 50%)`;
                ctx.fillRect(x, (canvas.height - barHeight) / 2, barWidth, barHeight);
                x += barWidth + 1;
            }
        };
        draw();
    }

    loadQuestion() {
        if (this.qIndex >= this.questions.length) {
            this.endGame();
            return;
        }

        const q = this.questions[this.qIndex];
        this.els.qNum.innerText = this.qIndex + 1;
        this.els.overlay.classList.add('hidden');
        this.els.options.innerHTML = '';
        this.els.status.innerText = "æ­£åœ¨è¼‰å…¥éŸ³è¨Š...";
        this.els.loading.classList.remove('hidden');
        this.els.timerBar.style.transition = 'none';
        this.els.timerBar.style.width = '100%';

        if(this.timer) clearInterval(this.timer);
        this.els.audio.src = q.audioUrl;
        this.els.audio.volume = 0.6;

        this.els.audio.oncanplay = () => {
            this.els.loading.classList.add('hidden');
            this.els.status.innerText = "ğŸ¶ çŒœçŒœé€™æ˜¯å“ªéƒ¨é›»å½±ï¼Ÿ";
            this.els.audio.play().catch(() => {
                this.els.status.innerText = "âš ï¸ è«‹é»æ“Šç•«é¢æ’­æ”¾";
            });
            this.startTimer();
            this.els.audio.oncanplay = null;
        };

        this.els.audio.onerror = () => {
            this.els.status.innerText = "âš ï¸ éŸ³è¨Šé€£çµéŒ¯èª¤ (éœ€è¨­å®š)";
            this.els.loading.classList.add('hidden');
        };

        this.generateOptions(q);
    }

    generateOptions(correct) {
        let wrong = ALL_MOVIES
            .filter(m => m.id !== correct.id)
            .sort(() => Math.random() - 0.5)
            .slice(0, 3);
        let all = [...wrong, correct].sort(() => Math.random() - 0.5);

        all.forEach(opt => {
            const btn = document.createElement('button');
            btn.className = 'option-btn';
            btn.innerHTML = `<span>${opt.title}</span>`;
            btn.onclick = (e) => this.checkAnswer(opt, correct, e.currentTarget);
            this.els.options.appendChild(btn);
        });
    }

    startTimer() {
        this.timeLeft = this.maxTime;
        setTimeout(() => {
            this.els.timerBar.style.transition = `width ${this.maxTime}s linear`;
            this.els.timerBar.style.width = '0%';
        }, 50);

        this.timer = setInterval(() => {
            this.timeLeft--;
            if(this.timeLeft <= 0) this.handleTimeout();
        }, 1000);
    }

    checkAnswer(selected, correct, btn) {
        clearInterval(this.timer);
        this.els.audio.pause();
        const buttons = document.querySelectorAll('.option-btn');
        buttons.forEach(b => b.disabled = true);

        const isCorrect = selected.id === correct.id;
        
        if(isCorrect) {
            btn.classList.add('correct');
            this.playTone('correct');
            const bonus = Math.ceil(this.timeLeft * 3);
            const points = 100 + bonus;
            this.score += points;
            this.showScoreFloat(btn, `+${points}`, 'plus');
            this.showResultModal(correct, true);
        } else {
            btn.classList.add('wrong');
            this.playTone('wrong');
            this.showScoreFloat(btn, "Miss", 'minus');
            buttons.forEach(b => {
                if(b.innerText.includes(correct.title)) b.classList.add('correct');
            });
            this.showResultModal(correct, false);
        }
        this.els.score.innerText = this.score;
    }

    // Function integrated from Old Code concept
    showScoreFloat(element, text, type) {
        const floatEl = document.createElement('span');
        floatEl.className = `score-float ${type}`;
        floatEl.innerText = text;
        element.appendChild(floatEl);
    }

    handleTimeout() {
        clearInterval(this.timer);
        this.els.audio.pause();
        this.playTone('wrong');
        document.querySelectorAll('.option-btn').forEach(b => {
            b.disabled = true;
            if(b.innerText.includes(this.questions[this.qIndex].title)) b.classList.add('correct');
        });
        this.showResultModal(this.questions[this.qIndex], false, true);
    }

    showResultModal(movie, isCorrect, isTimeout = false) {
        if(isTimeout) {
            this.els.resStatus.innerText = "Time's Up!";
            this.els.resStatus.style.color = "#ffcc00";
        } else if(isCorrect) {
            this.els.resStatus.innerText = "Correct! ğŸ‰";
            this.els.resStatus.style.color = "var(--success)";
        } else {
            this.els.resStatus.innerText = "Wrong... ğŸ˜¢";
            this.els.resStatus.style.color = "var(--error)";
        }

        this.els.resTitle.innerText = `${movie.title} (${movie.year})`;
        this.els.resSong.innerText = `ğŸµ ${movie.song}`;
        this.els.resDesc.innerText = movie.desc;
        
        setTimeout(() => {
            this.els.overlay.classList.remove('hidden');
        }, 800);
    }

    nextQuestion() {
        this.qIndex++;
        this.loadQuestion();
    }

    endGame() {
        this.switchScreen('end');
        document.getElementById('final-score').innerText = this.score;
        let msg = "";
        if (this.score > 1200) msg = "ä½ æ˜¯ OST ä¹‹ç¥ï¼è½è¦ºå¤ªæ•éŠ³äº†ï¼ğŸ†";
        else if (this.score > 800) msg = "è³‡æ·±å½±è¿·ï¼é…æ¨‚éƒ½è¨˜å¾—å¾ˆç†Ÿå–”ï¼ğŸ¬";
        else msg = "ä¸éŒ¯çš„å˜—è©¦ï¼å¤šçœ‹é»é›»å½±å†ä¾†æŒ‘æˆ°ï¼ğŸ¿";
        document.getElementById('feedback-msg').innerText = msg;
    }

    switchScreen(name) {
        this.els.start.classList.add('hidden');
        this.els.game.classList.add('hidden');
        this.els.end.classList.add('hidden');
        this.els[name].classList.remove('hidden');
        this.els[name].style.animation = 'none';
        this.els[name].offsetHeight; 
        this.els[name].style.animation = 'fadeIn 0.5s ease';
    }
}

const game = new GameEngine();

</script>
</body>
</html>
